<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrassMidi æ§åˆ¶å°</title>
    <style>
        :root {
            /* OBS é£æ ¼é…è‰² */
            --bg-color: transparent;
            /* ç”± OBS å†³å®šèƒŒæ™¯ */
            --panel-bg: rgba(43, 46, 56, 0.95);
            /* OBS Yami æ·±è‰²èƒŒæ™¯ */
            --text-color: #efefef;
            --sub-text: #aaaaaa;
            --accent-color: #00dbbf;
            /* ä¿æŒ Grass é£æ ¼ */
            --accent-hover: #00b39b;
            --danger-color: #e04f4f;
            --border-radius: 6px;
            --border-color: #3e424e;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 10px;
            font-size: 13px;
            height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* é¡¶éƒ¨æ  */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            flex-shrink: 0;
        }

        .bar-left,
        .bar-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h3 {
            margin: 0;
            font-size: 16px;
            color: var(--accent-color);
        }

        /* LED æŒ‡ç¤ºç¯ */
        .indicator {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: var(--sub-text);
            gap: 5px;
        }

        .led {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #444;
            transition: background-color 0.1s;
        }

        .led.active {
            background-color: #0f0;
            box-shadow: 0 0 5px #0f0;
        }

        .led.warn {
            background-color: #f00;
        }

        /* æŒ‰é’® */
        button {
            background-color: var(--accent-color);
            color: #1a1a1a;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
        }

        button:hover {
            filter: brightness(0.9);
        }

        button.icon-btn {
            padding: 6px;
            background: #333;
            color: #fff;
        }

        button.danger {
            background-color: var(--danger-color);
            color: #fff;
        }

        /* ä¸»å†…å®¹åŒº (æ»šåŠ¨) */
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            border-top: 1px solid var(--border-color);
            padding-top: 10px;
        }

        /* ç»‘å®šåˆ—è¡¨ (å“åº”å¼ Grid/List) */
        .binding-list {
            display: grid;
            gap: 8px;
            /* é»˜è®¤å®½å± 3åˆ— */
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        }

        /* æçª„å±å¹• (< 500px) å˜ä¸ºå•åˆ— */
        @media (max-width: 500px) {
            .binding-list {
                grid-template-columns: 1fr;
            }
        }

        .binding-card {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-info {
            flex-grow: 1;
            width: 0;
            /* flex text truncate hack */
        }

        .card-row-1 {
            font-weight: bold;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-row-2 {
            font-size: 12px;
            color: var(--sub-text);
        }

        .card-midi {
            color: var(--accent-color);
            font-family: monospace;
        }

        .card-actions {
            margin-left: 10px;
        }

        /* è®¾ç½®èœå• (äºŒçº§è¦†ç›–å±‚) */
        .settings-overlay {
            position: absolute;
            top: 40px;
            right: 10px;
            left: 10px;
            background: #2b2e38;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: none;
        }

        .settings-overlay.show {
            display: block;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            color: var(--sub-text);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            box-sizing: border-box;
            background: #1a1a1a;
            border: 1px solid #444;
            color: white;
            padding: 6px;
            border-radius: 4px;
        }

        /* å­¦ä¹ æ¨¡å¼å…¨å±è¦†ç›– */
        .learning-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            backdrop-filter: blur(2px);
        }
    </style>
</head>

<body>

    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="top-bar">
        <div class="bar-left">
            <h3>GrassMidi</h3>
            <div class="indicator" title="MIDI æ´»åŠ¨">
                <div id="midiLed" class="led"></div> MIDI
            </div>
            <div class="indicator" title="OBS è¿æ¥çŠ¶æ€">
                <div id="obsLed" class="led"></div> OBS
            </div>
        </div>
        <div class="bar-right">
            <button onclick="startLearning()">+ æ·»åŠ ç»‘å®š</button>
            <button class="icon-btn" onclick="toggleSettings()">âš™ï¸ è®¾ç½®</button>
        </div>
    </div>

    <!-- è®¾ç½®é¢æ¿ (éšè—) -->
    <div id="settingsPanel" class="settings-overlay">
        <div class="form-group">
            <label>MIDI è¾“å…¥è®¾å¤‡</label>
            <div style="display:flex; gap:5px;">
                <select id="midiDeviceSelect"></select>
                <button onclick="saveMidiDevice()">ç¡®å®š</button>
            </div>
        </div>
        <hr style="border:0; border-top:1px solid #444; margin:10px 0;">
        <div class="form-group">
            <label>OBS WebSocket åœ°å€</label>
            <input type="text" id="obsUrl" value="ws://localhost:4455">
        </div>
        <div class="form-group">
            <label>OBS å¯†ç </label>
            <input type="password" id="obsPass">
        </div>
        <div style="text-align:right;">
            <button onclick="saveObsConfig()">ä¿å­˜å¹¶è¿æ¥</button>
        </div>
    </div>

    <!-- ä¸»åˆ—è¡¨åŒºåŸŸ -->
    <div class="main-content">
        <div id="bindingList" class="binding-list">
            <!-- å¡ç‰‡æ³¨å…¥ä½ç½® -->
        </div>
        <div id="emptyTip" style="text-align:center; color:#666; margin-top:20px; display:none;">
            æš‚æ— ç»‘å®šï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ 
        </div>
    </div>

    <!-- å­¦ä¹ æ¨¡å¼å¼¹çª— -->
    <div id="learningOverlay" class="learning-overlay">
        <h2 style="color:var(--accent-color)">å­¦ä¹ æ¨¡å¼</h2>
        <p style="color:#ccc">è¯·æ“ä½œ MIDI æ§åˆ¶å™¨...</p>

        <div id="learningStatus" style="font-size:1.2em; margin:10px; color:#fff;">...</div>

        <div id="bindingForm"
            style="background:#2b2e38; padding:20px; border-radius:8px; width: 300px; display:none; border: 1px solid #444;">
            <div class="form-group">
                <label>æ“ä½œç±»å‹</label>
                <select id="bindType" onchange="updateTargetPlaceholder()">
                    <option value="SystemVolume">ç³»ç»ŸéŸ³é‡ (Windows)</option>
                    <option value="ObsVolume">OBS æºéŸ³é‡</option>
                    <option value="ObsMute">OBS æºé™éŸ³åˆ‡æ¢</option>
                    <option value="ObsSwitchScene">OBS åˆ‡æ¢åœºæ™¯</option>
                    <option value="MediaPlayPause">åª’ä½“ æ’­æ”¾/æš‚åœ</option>
                    <option value="MediaNext">åª’ä½“ ä¸‹ä¸€æ›²</option>
                    <option value="MediaPrev">åª’ä½“ ä¸Šä¸€æ›²</option>
                    <option value="MediaStop">åª’ä½“ åœæ­¢</option>
                </select>
            </div>
            <div class="form-group">
                <label>ç›®æ ‡ (æº/åœºæ™¯åç§°)</label>
                <input type="text" id="bindTarget" placeholder="ç•™ç©º">
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                <button onclick="cancelLearn()" style="background:#555">å–æ¶ˆ</button>
                <button onclick="saveBinding()">ä¿å­˜</button>
            </div>
        </div>

        <button id="cancelLearnBtn" onclick="cancelLearn()"
            style="margin-top:20px; background:transparent; border:1px solid #666; color:#aaa;">å–æ¶ˆ</button>
    </div>

    <script>
        let currentConfig = {};
        let learnedMidi = null;
        let lastMidiTime = 0;

        const typeLabels = {
            "SystemVolume": "ğŸ’» ç³»ç»ŸéŸ³é‡",
            "ObsVolume": "ğŸ”Š OBS éŸ³é‡",
            "ObsMute": "ğŸ”‡ OBS é™éŸ³",
            "ObsSwitchScene": "ğŸ¬ åˆ‡æ¢åœºæ™¯",
            "MediaPlayPause": "â¯ï¸ æ’­æ”¾/æš‚åœ",
            "MediaNext": "â­ï¸ ä¸‹ä¸€æ›²",
            "MediaPrev": "â®ï¸ ä¸Šä¸€æ›²",
            "MediaStop": "â¹ï¸ åœæ­¢"
        };

        function toggleSettings() {
            const el = document.getElementById('settingsPanel');
            el.classList.toggle('show');
        }

        async function loadData() {
            const [configRes, devicesRes] = await Promise.all([
                fetch('/api/config'),
                fetch('/api/devices')
            ]);

            const devices = await devicesRes.json();
            currentConfig = await configRes.json();

            // è®¾å¤‡åˆ—è¡¨
            const sel = document.getElementById('midiDeviceSelect');
            sel.innerHTML = '';
            devices.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d;
                opt.innerText = d;
                if (d == currentConfig.selectedMidiDevice) opt.selected = true;
                sel.appendChild(opt);
            });

            // OBSé…ç½®
            document.getElementById('obsUrl').value = currentConfig.obsUrl;
            document.getElementById('obsPass').value = currentConfig.obsPassword;

            renderBindings();
        }

        function renderBindings() {
            const container = document.getElementById('bindingList');
            container.innerHTML = '';

            if (!currentConfig.bindings || currentConfig.bindings.length === 0) {
                document.getElementById('emptyTip').style.display = 'block';
                return;
            } else {
                document.getElementById('emptyTip').style.display = 'none';
            }

            currentConfig.bindings.forEach((b, idx) => {
                const card = document.createElement('div');
                card.className = 'binding-card';

                const midiText = `Ch.${b.channel} ${b.isControlChange ? 'CC' : 'Note'}.${b.note}`;
                const targetText = b.target ? `[${b.target}]` : '';

                card.innerHTML = `
                <div class="card-info">
                    <div class="card-row-1">${typeLabels[b.type] || b.type} <span style="font-weight:normal">${targetText}</span></div>
                    <div class="card-row-2">
                        <span class="card-midi">${midiText}</span>
                    </div>
                </div>
                <div class="card-actions">
                    <button class="icon-btn danger" onclick="deleteBinding(${idx})" title="åˆ é™¤">Ã—</button>
                </div>
            `;
                container.appendChild(card);
            });
        }

        async function saveMidiDevice() {
            currentConfig.selectedMidiDevice = document.getElementById('midiDeviceSelect').value;
            await saveConfig();
            alert('è®¾å¤‡å·²ä¿å­˜');
        }

        async function saveObsConfig() {
            currentConfig.obsUrl = document.getElementById('obsUrl').value;
            currentConfig.obsPassword = document.getElementById('obsPass').value;
            await saveConfig();
            location.reload();
        }

        async function saveConfig() {
            await fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(currentConfig)
            });
            document.getElementById('settingsPanel').classList.remove('show');
        }

        async function deleteBinding(idx) {
            if (!confirm('åˆ é™¤æ­¤ç»‘å®š?')) return;
            currentConfig.bindings.splice(idx, 1);
            await saveConfig();
            renderBindings();
        }

        // çŠ¶æ€è½®è¯¢ (LED + OBS)
        setInterval(async () => {
            // 1. MIDI Activity
            try {
                const res = await fetch('/api/midi/last');
                if (res.ok) {
                    const msg = await res.json();
                    if (msg && msg.timestamp > lastMidiTime) {
                        lastMidiTime = msg.timestamp;
                        flashMidiLed();
                    }
                }
            } catch { }
        }, 150);

        setInterval(async () => {
            try {
                const res = await fetch('/api/obs/status');
                const status = await res.json();
                const led = document.getElementById('obsLed');
                if (status.connected) {
                    led.className = 'led active';
                } else {
                    led.className = 'led warn';
                }
            } catch { }
        }, 2000);

        function flashMidiLed() {
            const led = document.getElementById('midiLed');
            led.classList.add('active');
            setTimeout(() => led.classList.remove('active'), 100);
        }

        function updateTargetPlaceholder() {
            const type = document.getElementById('bindType').value;
            const targetInput = document.getElementById('bindTarget');
            if (type === 'SystemVolume' || type.startsWith('Media')) {
                targetInput.placeholder = 'æ— éœ€å¡«å†™';
                targetInput.disabled = true;
            } else if (type === 'ObsSwitchScene') {
                targetInput.placeholder = 'è¾“å…¥åœºæ™¯åç§°';
                targetInput.disabled = false;
            } else {
                targetInput.placeholder = 'è¾“å…¥æºåç§°';
                targetInput.disabled = false;
            }
        }

        // Learning Logic
        let pollingInterval = null;

        function startLearning() {
            document.getElementById('learningOverlay').style.display = 'flex';
            document.getElementById('learningStatus').style.display = 'block';
            document.getElementById('bindingForm').style.display = 'none';
            document.getElementById('cancelLearnBtn').style.display = 'block';
            learnedMidi = null;

            // Poll
            pollingInterval = setInterval(async () => {
                const res = await fetch('/api/midi/last');
                if (res.ok) {
                    const msg = await res.json();
                    if (msg && msg.timestamp > Date.now() - 500) { // å¿…é¡»æ˜¯æœ€è¿‘ 0.5s çš„
                        learnedMidi = msg;
                        showBindingForm(msg);
                        clearInterval(pollingInterval);
                    }
                }
            }, 100);
        }

        function showBindingForm(msg) {
            document.getElementById('learningStatus').style.display = 'none';
            document.getElementById('cancelLearnBtn').style.display = 'none';
            document.getElementById('bindingForm').style.display = 'block';

            const type = msg.isControlChange ? 'æ—‹é’®/CC' : 'æŒ‰é”®/Note';
            document.querySelector('#bindingForm').previousElementSibling.innerText =
                `æ”¶åˆ°ä¿¡å·: Ch.${msg.channel} ${type} ${msg.note}`;

            // Auto select type preference
            const typeSel = document.getElementById('bindType');
            if (msg.isControlChange) {
                if (typeSel.value.startsWith('Media') || typeSel.value == 'ObsSwitchScene' || typeSel.value == 'ObsMute') {
                    typeSel.value = 'SystemVolume';
                }
            } else {
                if (typeSel.value == 'SystemVolume' || typeSel.value == 'ObsVolume') {
                    typeSel.value = 'MediaPlayPause';
                }
            }
            updateTargetPlaceholder();
        }

        function cancelLearn() {
            if (pollingInterval) clearInterval(pollingInterval);
            document.getElementById('learningOverlay').style.display = 'none';
        }

        async function saveBinding() {
            if (!learnedMidi) return;
            const newBinding = {
                channel: learnedMidi.channel,
                note: learnedMidi.note,
                isControlChange: learnedMidi.isControlChange,
                type: document.getElementById('bindType').value,
                target: document.getElementById('bindTarget').value
            };
            currentConfig.bindings.push(newBinding);
            await saveConfig();
            renderBindings();
            cancelLearn();
        }

        loadData();
    </script>

</body>

</html>